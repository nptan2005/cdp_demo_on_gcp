apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "airflow.fullname" . }}-webserver
  labels:
    app.kubernetes.io/name: {{ include "airflow.name" . }}
spec:
  replicas: {{ .Values.replicaCount | default 1 }}
  selector:
    matchLabels:
      app: {{ include "airflow.fullname" . }}-webserver
      component: webserver
  template:
    metadata:
      labels:
        app: {{ include "airflow.fullname" . }}-webserver
        component: webserver
    spec:
      serviceAccountName: {{ .Values.serviceAccount.name }}
      containers:
        - name: webserver
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          args: ["webserver"]
          env:
            - name: AIRFLOW__CORE__EXECUTOR
              value: "KubernetesExecutor"
            - name: OPENLINEAGE_URL
              value: "{{ .Values.openlineage.url | default "http://openlineage:5000" }}"
          ports:
            - containerPort: 8080
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 60
          # Place resources on its own line, then indent the YAML rendered by toYaml
          resources:
{{ toYaml .Values.resources.webserver | indent 12 }}