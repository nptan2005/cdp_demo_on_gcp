name: Build Apache Atlas (dist only)

on:
  workflow_dispatch:

jobs:
  build-dist:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    env:
      MAVEN_OPTS: "-Xms2g -Xmx2g"
      BRANCH: "release-2.4.0"                # đổi nếu cần (release-2.5.0, release-2.4.0,...)
      GIT_URL: "https://github.com/apache/atlas.git"
    steps:
      - name: Checkout tiny repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install OS deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y openjdk-11-jdk maven git dos2unix unzip curl
      - name: Set JAVA_HOME
        run: echo "JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV

      - name: Clone Apache Atlas
        run: |
          rm -rf atlas
          git clone --single-branch --branch ${BRANCH} ${GIT_URL} atlas
          cd atlas
          echo "Cloned $(git rev-parse --abbrev-ref HEAD) @ $(git rev-parse --short HEAD)"

      - name: Build distribution (skip heavy modules)
        run: |
          cd atlas
          mvn clean package -Pdist -DskipTests -Drat.skip=true -DskipDocs \
            -pl '!atlas-testtools,!webapp,!dashboardv2,!dashboardv3' -am -T1C

      - name: Collect dist artifacts
        run: |
          cd atlas
          mkdir -p dist
          find distro -maxdepth 3 -type f -name 'apache-atlas-*server.tar.gz' -print -exec cp -f {} dist/ \;
          ls -lh dist || true

      - name: Upload artifact (tar.gz)
        uses: actions/upload-artifact@v4
        with:
          name: apache-atlas-dist
          path: atlas/dist/